package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

var (
	// TODO yqq 2022-08-10, change this on mainnet
	devAdmin        = common.HexToAddress("0x9dEaa276B25863D5Df573fD00f364b64B72Ef0Ab")
	devAdminTestnet = common.HexToAddress("0xf513e4e5Ded9B510780D016c482fC158209DE9AA")
)

const (
	addressListCode = "0x608060405234801561001057600080fd5b50600436106101585760003560e01c80635eca4a70116100c3578063c4d66de81161007c578063c4d66de81461044c578063cec0705a14610472578063db6619b01461049e578063f851a440146104a6578063fb48270c146104ae578063ff0617df146104b657610158565b80635eca4a701461037a5780636dfb5176146103a057806370b03fc5146103cf57806389449301146103d75780639e23c2091461040c578063abbcbd3a1461043257610158565b8063327564b611610115578063327564b6146102d1578063349cb711146102d9578063367f8a581461030857806343e0c73a146103295780634f608dd3146103315780634fb9e9b71461035457610158565b80630c4763271461015d578063143d79b6146101c1578063158ef93e1461021157806318c662121461022d57806322fbf1e81461028557806326782247146102ad575b600080fd5b6101896004803603604081101561017357600080fd5b50803590602001356001600160801b03166104be565b60405180848152602001836001600160801b031681526020018260038111156101ae57fe5b8152602001935050505060405180910390f35b6101e7600480360360208110156101d757600080fd5b50356001600160a01b03166105a4565b6040518083151581526020018260028111156101ff57fe5b81526020019250505060405180910390f35b610219610626565b604080519115158252519081900360200190f35b61023561062f565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015610271578181015183820152602001610259565b505050509050019250505060405180910390f35b6102ab6004803603602081101561029b57600080fd5b50356001600160a01b0316610691565b005b6102b56107a2565b604080516001600160a01b039092168252519081900360200190f35b6102196107b1565b6102ab600480360360408110156102ef57600080fd5b5080356001600160a01b0316906020013560ff166107bf565b610310610a07565b6040805163ffffffff9092168252519081900360200190f35b6102ab610a0d565b6101896004803603602081101561034757600080fd5b503563ffffffff16610af8565b6102ab6004803603602081101561036a57600080fd5b50356001600160a01b0316610be7565b6102196004803603602081101561039057600080fd5b50356001600160a01b0316610c98565b6102ab600480360360408110156103b657600080fd5b5080356001600160a01b0316906020013560ff16610cb6565b610235610fdc565b610219600480360360608110156103ed57600080fd5b5080359060208101356001600160801b0316906040013560ff1661103c565b6102ab6004803603602081101561042257600080fd5b50356001600160a01b03166113d7565b61043a611569565b60408051918252519081900360200190f35b6102ab6004803603602081101561046257600080fd5b50356001600160a01b031661156f565b6102196004803603604081101561048857600080fd5b50803590602001356001600160801b0316611a8e565b6102ab611e87565b6102b5611f77565b6102ab611f8c565b61043a61205f565b6000828152600a602090815260408083206001600160801b03851684529091528120548190819080158015906104f657506009548111155b15610591576105036121fa565b6009600183038154811061051357fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b90910416600381111561056657fe5b600381111561057157fe5b90525080516020820151604090920151909650909450925061059d915050565b50600092508291508190505b9250925092565b6001600160a01b038116600090815260056020908152604080832054600690925282205482911580159115159082906105da5750805b156105ee5760016002935093505050610621565b81156106035760016000935093505050610621565b801561061757600180935093505050610621565b6000809350935050505b915091565b60005460ff1681565b6060600380548060200260200160405190810160405280929190818152602001828054801561068757602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610669575b5050505050905090565b6000546201000090046001600160a01b03163314806106ba5750600b546001600160a01b031633145b6106f8576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b6001600160a01b03811660009081526002602052604090205460ff1615610756576040805162461bcd60e51b815260206004820152600d60248201526c185b1c9958591e481859191959609a1b604482015290519081900360640190fd5b6001600160a01b038116600081815260026020526040808220805460ff19166001179055517f058fdae480ed8e99b762bceb2d39835a68ee3a4789cd84e5c90cd59722ba02099190a250565b6001546001600160a01b031681565b600054610100900460ff1681565b6000546201000090046001600160a01b03163314806107e85750600b546001600160a01b031633145b610826576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600281600281111561083457fe5b1415610915576001600160a01b038216600090815260056020526040902054610897576040805162461bcd60e51b815260206004820152601060248201526f1b9bdd081a5b88199c9bdb481b1a5cdd60821b604482015290519081900360640190fd5b6001600160a01b0382166000908152600660205260409020546108f2576040805162461bcd60e51b815260206004820152600e60248201526d1b9bdd081a5b881d1bc81b1a5cdd60921b604482015290519081900360640190fd5b61090160036005846000612065565b61091060046006846001612065565b6109ff565b600081600281111561092357fe5b1415610995576001600160a01b038216600090815260056020526040902054610986576040805162461bcd60e51b815260206004820152601060248201526f1b9bdd081a5b88199c9bdb481b1a5cdd60821b604482015290519081900360640190fd5b61091060036005846000612065565b6001600160a01b0382166000908152600660205260409020546109f0576040805162461bcd60e51b815260206004820152600e60248201526d1b9bdd081a5b881d1bc81b1a5cdd60921b604482015290519081900360640190fd5b6109ff60046006846001612065565b505043600755565b60095490565b6000546201000090046001600160a01b0316331480610a365750600b546001600160a01b031633145b610a74576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600054610100900460ff16610ac3576040805162461bcd60e51b815260206004820152601060248201526f185b1c9958591e48191a5cd8589b195960821b604482015290519081900360640190fd5b6000805461ff00191681556040517f733a7f99819dc7466bff56e7c0b6753b43b750a692f2a5bb4fe373815a0c7845908290a2565b60008060006009805490508463ffffffff1610610b51576040805162461bcd60e51b8152602060048201526012602482015271696e646578206f7574206f662072616e676560701b604482015290519081900360640190fd5b610b596121fa565b60098563ffffffff1681548110610b6c57fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b909104166003811115610bbf57fe5b6003811115610bca57fe5b905250805160208201516040909201519097919650945092505050565b6000546201000090046001600160a01b0316331480610c105750600b546001600160a01b031633145b610c4e576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b0383169081179091556040517faefcaa6215f99fe8c2f605dd268ee4d23a5b596bbca026e25ce8446187f4f1ba90600090a250565b6001600160a01b031660009081526002602052604090205460ff1690565b6000546201000090046001600160a01b0316331480610cdf5750600b546001600160a01b031633145b610d1d576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b6000546001600160a01b03838116620100009092041614801590610d4f5750600b546001600160a01b03838116911614155b610da0576040805162461bcd60e51b815260206004820152601d60248201527f63616e6e6f74206164642061646d696e20746f20626c61636b6c697374000000604482015290519081900360640190fd5b6002816002811115610dae57fe5b1415610e95576001600160a01b03821660009081526005602052604090205415610e16576040805162461bcd60e51b8152602060048201526014602482015273185b1c9958591e481a5b88199c9bdb481b1a5cdd60621b604482015290519081900360640190fd5b6001600160a01b03821660009081526006602052604090205415610e76576040805162461bcd60e51b8152602060048201526012602482015271185b1c9958591e481a5b881d1bc81b1a5cdd60721b604482015290519081900360640190fd5b610e8360036005846121b7565b610e9060046006846121b7565b610f85565b6000816002811115610ea357fe5b1415610f18576001600160a01b03821660009081526005602052604090205415610f0b576040805162461bcd60e51b8152602060048201526014602482015273185b1c9958591e481a5b88199c9bdb481b1a5cdd60621b604482015290519081900360640190fd5b610e9060036005846121b7565b6001600160a01b03821660009081526006602052604090205415610f78576040805162461bcd60e51b8152602060048201526012602482015271185b1c9958591e481a5b881d1bc81b1a5cdd60721b604482015290519081900360640190fd5b610f8560046006846121b7565b43600781905550816001600160a01b03167f4bb8845da5ed7c2df200814ba7a0f3db11326cc817cf9a042fa54d4e5f6f29bb8260405180826002811115610fc857fe5b815260200191505060405180910390a25050565b60606004805480602002602001604051908101604052809291908181526020018280548015610687576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311610669575050505050905090565b600080546201000090046001600160a01b03163314806110665750600b546001600160a01b031633145b6110a4576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b836110f6576040805162461bcd60e51b815260206004820152601d60248201527f6576656e745369676e6174757265206d757374206e6f7420656d707479000000604482015290519081900360640190fd5b6000836001600160801b031611611154576040805162461bcd60e51b815260206004820152601f60248201527f636865636b20696e646578206d7573742067726561746572207468616e203000604482015290519081900360640190fd5b600082600381111561116257fe5b11801561117b5750600382600381111561117857fe5b11155b6111c1576040805162461bcd60e51b8152602060048201526012602482015271696e76616c696420636865636b207479706560701b604482015290519081900360640190fd5b6000848152600a602090815260408083206001600160801b0387168452909152902054801561128b576000600960018303815481106111fc57fe5b90600052602060002090600202019050838160010160106101000a81548160ff0219169083600381111561122c57fe5b0217905550857f07b8dde0de807efa8ecba675ef2be9d8af8f01e266085068e60c8e76837ee11a868660405180836001600160801b0316815260200182600381111561127457fe5b81526020019250505060405180910390a2506113c8565b6112936121fa565b6040518060600160405280878152602001866001600160801b031681526020018560038111156112bf57fe5b905260098054600181018255600091909152815160029091026000805160206122398339815191528101918255602083015160008051602061221983398151915290910180546001600160801b039092166001600160801b03199092169190911780825560408401519394508493919060ff60801b1916600160801b83600381111561134757fe5b0217905550506009546000888152600a602090815260408083206001600160801b038b16808552908352928190209390935591519081528892507f441fbdf9d33c890abf8663a8fd49b8ee03e20ba4cce546dfa92d8bce8f1abf6b918891889181018260038111156113b557fe5b81526020019250505060405180910390a2505b50504360085560019392505050565b6000546201000090046001600160a01b03163314806114005750600b546001600160a01b031633145b61143e576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b6001600160a01b03811660009081526002602052604090205460ff1661149d576040805162461bcd60e51b815260206004820152600f60248201526e3737ba1030903232bb32b637b832b960891b604482015290519081900360640190fd5b6000546001600160a01b038281166201000090920416148015906114cf5750600b546001600160a01b03828116911614155b611520576040805162461bcd60e51b815260206004820152601760248201527f61646d696e2063616e6e6f742062652072656d6f766564000000000000000000604482015290519081900360640190fd5b6001600160a01b038116600081815260026020526040808220805460ff19169055517f110a48e3e347ae018d4d40446e4e917b416f912dec489da19b4507bb9bb18cd49190a250565b60075481565b60005460ff16156115bd576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b600b80546001600160a01b0319166001600160a01b03838116918217928390556000805461010062010000600160b01b0319909116620100009485021760ff19908116600190811761ff0019169290921783559483168252600260205260408083208054871683179055825494909404909216815291909120805490921617905560085415611693576040805162461bcd60e51b815260206004820152601e60248201527f4f6e6c7920696e697469616c697a65206265666f726520616e79207573650000604482015290519081900360640190fd5b600754156116e8576040805162461bcd60e51b815260206004820152601e60248201527f4f6e6c7920696e697469616c697a65206265666f726520616e79207573650000604482015290519081900360640190fd5b7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60016117136121fa565b50604080516060810182528381526001600160801b0383811660208301908152600193830184815260098054958601815560005283516000805160206122398339815191526002909602958601908155915160008051602061221983398151915290950180546001600160801b031916959093169490941780835593519293849391929060ff60801b1916600160801b8360038111156117af57fe5b021790555050600980546000958652600a602090815260408088206001600160801b039788168952825280882083905580516060810182527f06b541ddaa720db2b10a4d0cdac39b8d360425fc073085fac19bc82614677987808252600293820184815260019383018481529386018755959099528051600080516020612239833981519152948402948501908155945160008051602061221983398151915290940180546001600160801b03191694909816939093178088559051919692955085945090919060ff60801b1916600160801b83600381111561188e57fe5b021790555050600980546000958652600a602090815260408088206001600160801b03888116808b52918452828a2085905582516060810184527fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62808252948101928352600193810184815293860187559590995284516002909402600080516020612239833981519152810194855590516000805160206122198339815191529091018054919099166001600160801b031990911617808955905191979395508594509192909160ff60801b1916600160801b83600381111561196e57fe5b021790555050600980546000958652600a602090815260408088206001600160801b03888116808b52918452828a2085905582516060810184527f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb808252948101928352600193810184815293860187559590995284516002909402600080516020612239833981519152810194855590516000805160206122198339815191529091018054919099166001600160801b031990911617808955905191979395508594509192909160ff60801b1916600160801b836003811115611a4e57fe5b0217905550506009546000948552600a602090815260408087206001600160801b0390961687529490529290932091909155505043600781905560085550565b600080546201000090046001600160a01b0316331480611ab85750600b546001600160a01b031633145b611af6576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b82611b48576040805162461bcd60e51b815260206004820152601d60248201527f6576656e745369676e6174757265206d757374206e6f7420656d707479000000604482015290519081900360640190fd5b6000826001600160801b031611611ba6576040805162461bcd60e51b815260206004820152601f60248201527f636865636b20696e646578206d7573742067726561746572207468656e203000604482015290519081900360640190fd5b6000838152600a602090815260408083206001600160801b0386168452909152902054611c0b576040805162461bcd60e51b815260206004820152600e60248201526d1c9d5b19481b9bdd08195e1a5cdd60921b604482015290519081900360640190fd5b6000838152600a602090815260408083206001600160801b038616845290915281208054919055611c3a6121fa565b60096001830381548110611c4a57fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b909104166003811115611c9d57fe5b6003811115611ca857fe5b9052506009549091508214611dd657611cbf6121fa565b600980546000198101908110611cd157fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b909104166003811115611d2457fe5b6003811115611d2f57fe5b8152505090508060096001850381548110611d4657fe5b6000918252602091829020835160029290920201908155908201516001820180546001600160801b0319166001600160801b03909216919091178082556040840151919060ff60801b1916600160801b836003811115611da257fe5b02179055505081516000908152600a60209081526040808320948201516001600160801b0316835293905291909120839055505b6009805480611de157fe5b60008281526020808220600260001990940193840201918255600191909101805470ffffffffffffffffffffffffffffffffff19169055915581518282015160408085015190516001600160801b038316815292937f89fdef5ae498cf51728b26200045df6c8a41d44fee8191778fa2bcb855a725de93908101826003811115611e6757fe5b81526020019250505060405180910390a250504360085550600192915050565b6000546201000090046001600160a01b0316331480611eb05750600b546001600160a01b031633145b611eee576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600054610100900460ff1615611f3d576040805162461bcd60e51b815260206004820152600f60248201526e185b1c9958591e48195b98589b1959608a1b604482015290519081900360640190fd5b6000805461ff0019166101001781556040516001917f733a7f99819dc7466bff56e7c0b6753b43b750a692f2a5bb4fe373815a0c784591a2565b6000546201000090046001600160a01b031681565b6001546001600160a01b03163314611fdc576040805162461bcd60e51b815260206004820152600e60248201526d4e65772061646d696e206f6e6c7960901b604482015290519081900360640190fd5b600180546000805462010000600160b01b0319166001600160a01b03808416620100009081029290921783556001600160a01b0319909316845533825260026020526040808320805460ff1916909517909455815493519304909116917f7ce7ec0b50378fb6c0186ffb5f48325f6593fcb4ca4386f21861af3129188f5c9190a2565b60085481565b6001600160a01b03821660009081526020849052604081208054919055845460001991820191018114612135578454859060001981019081106120a457fe5b9060005260206000200160009054906101000a90046001600160a01b03168582815481106120ce57fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055508060010184600087848154811061210f57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020555b8480548061213f57fe5b600082815260209020810160001990810180546001600160a01b03191690550190556040516001600160a01b038416907f91b762fba034b39c8b14c1e6463a15b1f4c211dcd0023f7fa2f4ae2928dfc44d908490808260028111156121a057fe5b815260200191505060405180910390a25050505050565b82546001810184556000848152602080822090920180546001600160a01b039094166001600160a01b031990941684179055935491845291909152604090912055565b6040805160608101825260008082526020820181905290918201529056fe6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7b06e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7afa26469706673582212206ffac5fefd948406f907d3788663eae9c356b39bf16bda8a2c98b2bb99d3225964736f6c634300060c0033"
)

type hardForkAddressList struct {
}

func (s *hardForkAddressList) GetName() string {
	return AddressListContractName
}

func (s *hardForkAddressList) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(addressListCode)

	//write addressListCode to sys contract
	state.SetCode(AddressListContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", AddressListContractAddr.String(), "code", addressListCode)

	return
}

func (s *hardForkAddressList) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return devAdmin
	}

	return devAdminTestnet
}

func GetAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return devAdmin
	}

	return devAdminTestnet
}

func (s *hardForkAddressList) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	method := "initialize"
	data, err := GetInteractiveABI()[AddressListContractName].Pack(method, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &AddressListContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
