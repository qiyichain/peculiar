package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

var (
	// TODO yqq 2022-08-10, change this on mainnet
	devAdmin        = common.HexToAddress("0xf513e4e5Ded9B510780D016c482fC158209DE9AA")
	devAdminTestnet = common.HexToAddress("0xf513e4e5Ded9B510780D016c482fC158209DE9AA")
)

const (
	addressListCode = "0x608060405234801561001057600080fd5b50600436106101585760003560e01c80635eca4a70116100c3578063c4d66de81161007c578063c4d66de81461044c578063cec0705a14610472578063db6619b01461049e578063f851a440146104a6578063fb48270c146104ae578063ff0617df146104b657610158565b80635eca4a701461037a5780636dfb5176146103a057806370b03fc5146103cf57806389449301146103d75780639e23c2091461040c578063abbcbd3a1461043257610158565b8063327564b611610115578063327564b6146102d1578063349cb711146102d9578063367f8a581461030857806343e0c73a146103295780634f608dd3146103315780634fb9e9b71461035457610158565b80630c4763271461015d578063143d79b6146101c1578063158ef93e1461021157806318c662121461022d57806322fbf1e81461028557806326782247146102ad575b600080fd5b6101896004803603604081101561017357600080fd5b50803590602001356001600160801b03166104be565b60405180848152602001836001600160801b031681526020018260038111156101ae57fe5b8152602001935050505060405180910390f35b6101e7600480360360208110156101d757600080fd5b50356001600160a01b03166105a4565b6040518083151581526020018260028111156101ff57fe5b81526020019250505060405180910390f35b610219610626565b604080519115158252519081900360200190f35b61023561062f565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015610271578181015183820152602001610259565b505050509050019250505060405180910390f35b6102ab6004803603602081101561029b57600080fd5b50356001600160a01b0316610691565b005b6102b561078d565b604080516001600160a01b039092168252519081900360200190f35b61021961079c565b6102ab600480360360408110156102ef57600080fd5b5080356001600160a01b0316906020013560ff166107aa565b6103106109dd565b6040805163ffffffff9092168252519081900360200190f35b6102ab6109e3565b6101896004803603602081101561034757600080fd5b503563ffffffff16610ab9565b6102ab6004803603602081101561036a57600080fd5b50356001600160a01b0316610ba8565b6102196004803603602081101561039057600080fd5b50356001600160a01b0316610c44565b6102ab600480360360408110156103b657600080fd5b5080356001600160a01b0316906020013560ff16610c62565b610235610f59565b610219600480360360608110156103ed57600080fd5b5080359060208101356001600160801b0316906040013560ff16610fb9565b6102ab6004803603602081101561042257600080fd5b50356001600160a01b031661133f565b61043a611439565b60408051918252519081900360200190f35b6102ab6004803603602081101561046257600080fd5b50356001600160a01b031661143f565b6102196004803603604081101561048857600080fd5b50803590602001356001600160801b03166114c3565b6102ab6118a7565b6102b5611982565b6102ab611997565b61043a611a51565b6000828152600a602090815260408083206001600160801b03851684529091528120548190819080158015906104f657506009548111155b156105915761050361203b565b6009600183038154811061051357fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b90910416600381111561056657fe5b600381111561057157fe5b90525080516020820151604090920151909650909450925061059d915050565b50600092508291508190505b9250925092565b6001600160a01b038116600090815260056020908152604080832054600690925282205482911580159115159082906105da5750805b156105ee5760016002935093505050610621565b81156106035760016000935093505050610621565b801561061757600180935093505050610621565b6000809350935050505b915091565b60005460ff1681565b6060600380548060200260200160405190810160405280929190818152602001828054801561068757602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610669575b5050505050905090565b6000546201000090046001600160a01b031633146106e3576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b6001600160a01b03811660009081526002602052604090205460ff1615610741576040805162461bcd60e51b815260206004820152600d60248201526c185b1c9958591e481859191959609a1b604482015290519081900360640190fd5b6001600160a01b038116600081815260026020526040808220805460ff19166001179055517f058fdae480ed8e99b762bceb2d39835a68ee3a4789cd84e5c90cd59722ba02099190a250565b6001546001600160a01b031681565b600054610100900460ff1681565b6000546201000090046001600160a01b031633146107fc576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600281600281111561080a57fe5b14156108eb576001600160a01b03821660009081526005602052604090205461086d576040805162461bcd60e51b815260206004820152601060248201526f1b9bdd081a5b88199c9bdb481b1a5cdd60821b604482015290519081900360640190fd5b6001600160a01b0382166000908152600660205260409020546108c8576040805162461bcd60e51b815260206004820152600e60248201526d1b9bdd081a5b881d1bc81b1a5cdd60921b604482015290519081900360640190fd5b6108d760036005846000611a57565b6108e660046006846001611a57565b6109d5565b60008160028111156108f957fe5b141561096b576001600160a01b03821660009081526005602052604090205461095c576040805162461bcd60e51b815260206004820152601060248201526f1b9bdd081a5b88199c9bdb481b1a5cdd60821b604482015290519081900360640190fd5b6108e660036005846000611a57565b6001600160a01b0382166000908152600660205260409020546109c6576040805162461bcd60e51b815260206004820152600e60248201526d1b9bdd081a5b881d1bc81b1a5cdd60921b604482015290519081900360640190fd5b6109d560046006846001611a57565b505043600755565b60095490565b6000546201000090046001600160a01b03163314610a35576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600054610100900460ff16610a84576040805162461bcd60e51b815260206004820152601060248201526f185b1c9958591e48191a5cd8589b195960821b604482015290519081900360640190fd5b6000805461ff00191681556040517f733a7f99819dc7466bff56e7c0b6753b43b750a692f2a5bb4fe373815a0c7845908290a2565b60008060006009805490508463ffffffff1610610b12576040805162461bcd60e51b8152602060048201526012602482015271696e646578206f7574206f662072616e676560701b604482015290519081900360640190fd5b610b1a61203b565b60098563ffffffff1681548110610b2d57fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b909104166003811115610b8057fe5b6003811115610b8b57fe5b905250805160208201516040909201519097919650945092505050565b6000546201000090046001600160a01b03163314610bfa576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b0383169081179091556040517faefcaa6215f99fe8c2f605dd268ee4d23a5b596bbca026e25ce8446187f4f1ba90600090a250565b6001600160a01b031660009081526002602052604090205460ff1690565b6000546201000090046001600160a01b03163314610cb4576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b6000546001600160a01b0383811662010000909204161415610d1d576040805162461bcd60e51b815260206004820152601d60248201527f63616e6e6f74206164642061646d696e20746f20626c61636b6c697374000000604482015290519081900360640190fd5b6002816002811115610d2b57fe5b1415610e12576001600160a01b03821660009081526005602052604090205415610d93576040805162461bcd60e51b8152602060048201526014602482015273185b1c9958591e481a5b88199c9bdb481b1a5cdd60621b604482015290519081900360640190fd5b6001600160a01b03821660009081526006602052604090205415610df3576040805162461bcd60e51b8152602060048201526012602482015271185b1c9958591e481a5b881d1bc81b1a5cdd60721b604482015290519081900360640190fd5b610e006003600584611ba9565b610e0d6004600684611ba9565b610f02565b6000816002811115610e2057fe5b1415610e95576001600160a01b03821660009081526005602052604090205415610e88576040805162461bcd60e51b8152602060048201526014602482015273185b1c9958591e481a5b88199c9bdb481b1a5cdd60621b604482015290519081900360640190fd5b610e0d6003600584611ba9565b6001600160a01b03821660009081526006602052604090205415610ef5576040805162461bcd60e51b8152602060048201526012602482015271185b1c9958591e481a5b881d1bc81b1a5cdd60721b604482015290519081900360640190fd5b610f026004600684611ba9565b43600781905550816001600160a01b03167f4bb8845da5ed7c2df200814ba7a0f3db11326cc817cf9a042fa54d4e5f6f29bb8260405180826002811115610f4557fe5b815260200191505060405180910390a25050565b60606004805480602002602001604051908101604052809291908181526020018280548015610687576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311610669575050505050905090565b600080546201000090046001600160a01b0316331461100c576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b8361105e576040805162461bcd60e51b815260206004820152601d60248201527f6576656e745369676e6174757265206d757374206e6f7420656d707479000000604482015290519081900360640190fd5b6000836001600160801b0316116110bc576040805162461bcd60e51b815260206004820152601f60248201527f636865636b20696e646578206d7573742067726561746572207468616e203000604482015290519081900360640190fd5b60008260038111156110ca57fe5b1180156110e3575060038260038111156110e057fe5b11155b611129576040805162461bcd60e51b8152602060048201526012602482015271696e76616c696420636865636b207479706560701b604482015290519081900360640190fd5b6000848152600a602090815260408083206001600160801b038716845290915290205480156111f35760006009600183038154811061116457fe5b90600052602060002090600202019050838160010160106101000a81548160ff0219169083600381111561119457fe5b0217905550857f07b8dde0de807efa8ecba675ef2be9d8af8f01e266085068e60c8e76837ee11a868660405180836001600160801b031681526020018260038111156111dc57fe5b81526020019250505060405180910390a250611330565b6111fb61203b565b6040518060600160405280878152602001866001600160801b0316815260200185600381111561122757fe5b9052600980546001810182556000919091528151600290910260008051602061207a8339815191528101918255602083015160008051602061205a83398151915290910180546001600160801b039092166001600160801b03199092169190911780825560408401519394508493919060ff60801b1916600160801b8360038111156112af57fe5b0217905550506009546000888152600a602090815260408083206001600160801b038b16808552908352928190209390935591519081528892507f441fbdf9d33c890abf8663a8fd49b8ee03e20ba4cce546dfa92d8bce8f1abf6b9188918891810182600381111561131d57fe5b81526020019250505060405180910390a2505b50504360085560019392505050565b6000546201000090046001600160a01b03163314611391576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b6001600160a01b03811660009081526002602052604090205460ff166113f0576040805162461bcd60e51b815260206004820152600f60248201526e3737ba1030903232bb32b637b832b960891b604482015290519081900360640190fd5b6001600160a01b038116600081815260026020526040808220805460ff19169055517f110a48e3e347ae018d4d40446e4e917b416f912dec489da19b4507bb9bb18cd49190a250565b60075481565b60005460ff161561148d576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b60008054600162010000600160b01b0319909116620100006001600160a01b038516021760ff19161790556114c0611bec565b50565b600080546201000090046001600160a01b03163314611516576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b82611568576040805162461bcd60e51b815260206004820152601d60248201527f6576656e745369676e6174757265206d757374206e6f7420656d707479000000604482015290519081900360640190fd5b6000826001600160801b0316116115c6576040805162461bcd60e51b815260206004820152601f60248201527f636865636b20696e646578206d7573742067726561746572207468656e203000604482015290519081900360640190fd5b6000838152600a602090815260408083206001600160801b038616845290915290205461162b576040805162461bcd60e51b815260206004820152600e60248201526d1c9d5b19481b9bdd08195e1a5cdd60921b604482015290519081900360640190fd5b6000838152600a602090815260408083206001600160801b03861684529091528120805491905561165a61203b565b6009600183038154811061166a57fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b9091041660038111156116bd57fe5b60038111156116c857fe5b90525060095490915082146117f6576116df61203b565b6009805460001981019081106116f157fe5b60009182526020918290206040805160608101825260029093029091018054835260018101546001600160801b0381169484019490945291929083019060ff600160801b90910416600381111561174457fe5b600381111561174f57fe5b815250509050806009600185038154811061176657fe5b6000918252602091829020835160029290920201908155908201516001820180546001600160801b0319166001600160801b03909216919091178082556040840151919060ff60801b1916600160801b8360038111156117c257fe5b02179055505081516000908152600a60209081526040808320948201516001600160801b0316835293905291909120839055505b600980548061180157fe5b60008281526020808220600260001990940193840201918255600191909101805470ffffffffffffffffffffffffffffffffff19169055915581518282015160408085015190516001600160801b038316815292937f89fdef5ae498cf51728b26200045df6c8a41d44fee8191778fa2bcb855a725de9390810182600381111561188757fe5b81526020019250505060405180910390a250504360085550600192915050565b6000546201000090046001600160a01b031633146118f9576040805162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b604482015290519081900360640190fd5b600054610100900460ff1615611948576040805162461bcd60e51b815260206004820152600f60248201526e185b1c9958591e48195b98589b1959608a1b604482015290519081900360640190fd5b6000805461ff0019166101001781556040516001917f733a7f99819dc7466bff56e7c0b6753b43b750a692f2a5bb4fe373815a0c784591a2565b6000546201000090046001600160a01b031681565b6001546001600160a01b031633146119e7576040805162461bcd60e51b815260206004820152600e60248201526d4e65772061646d696e206f6e6c7960901b604482015290519081900360640190fd5b600180546000805462010000600160b01b0319166001600160a01b0380841662010000908102929092178084556001600160a01b03199094169094556040519204909216917f7ce7ec0b50378fb6c0186ffb5f48325f6593fcb4ca4386f21861af3129188f5c91a2565b60085481565b6001600160a01b03821660009081526020849052604081208054919055845460001991820191018114611b2757845485906000198101908110611a9657fe5b9060005260206000200160009054906101000a90046001600160a01b0316858281548110611ac057fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555080600101846000878481548110611b0157fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020555b84805480611b3157fe5b600082815260209020810160001990810180546001600160a01b03191690550190556040516001600160a01b038416907f91b762fba034b39c8b14c1e6463a15b1f4c211dcd0023f7fa2f4ae2928dfc44d90849080826002811115611b9257fe5b815260200191505060405180910390a25050505050565b82546001810184556000848152602080822090920180546001600160a01b039094166001600160a01b031990941684179055935491845291909152604090912055565b60085415611c41576040805162461bcd60e51b815260206004820152601e60248201527f4f6e6c7920696e697469616c697a65206265666f726520616e79207573650000604482015290519081900360640190fd5b60075415611c96576040805162461bcd60e51b815260206004820152601e60248201527f4f6e6c7920696e697469616c697a65206265666f726520616e79207573650000604482015290519081900360640190fd5b7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef6001611cc161203b565b50604080516060810182528381526001600160801b03838116602083019081526001938301848152600980549586018155600052835160008051602061207a8339815191526002909602958601908155915160008051602061205a83398151915290950180546001600160801b031916959093169490941780835593519293849391929060ff60801b1916600160801b836003811115611d5d57fe5b021790555050600980546000958652600a602090815260408088206001600160801b039788168952825280882083905580516060810182527f06b541ddaa720db2b10a4d0cdac39b8d360425fc073085fac19bc8261467798780825260029382018481526001938301848152938601875595909952805160008051602061207a833981519152948402948501908155945160008051602061205a83398151915290940180546001600160801b03191694909816939093178088559051919692955085945090919060ff60801b1916600160801b836003811115611e3c57fe5b021790555050600980546000958652600a602090815260408088206001600160801b03888116808b52918452828a2085905582516060810184527fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6280825294810192835260019381018481529386018755959099528451600290940260008051602061207a8339815191528101948555905160008051602061205a8339815191529091018054919099166001600160801b031990911617808955905191979395508594509192909160ff60801b1916600160801b836003811115611f1c57fe5b021790555050600980546000958652600a602090815260408088206001600160801b03888116808b52918452828a2085905582516060810184527f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb80825294810192835260019381018481529386018755959099528451600290940260008051602061207a8339815191528101948555905160008051602061205a8339815191529091018054919099166001600160801b031990911617808955905191979395508594509192909160ff60801b1916600160801b836003811115611ffc57fe5b0217905550506009546000948552600a602090815260408087206001600160801b03909616875294905292909320919091555050436007819055600855565b6040805160608101825260008082526020820181905290918201529056fe6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7b06e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7afa264697066735822122088bb567ba4d5182aa74cb7bd76ee8d8d7e689a481a389ce326d3d0e863a324cd64736f6c634300060c0033"
)

type hardForkAddressList struct {
}

func (s *hardForkAddressList) GetName() string {
	return AddressListContractName
}

func (s *hardForkAddressList) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(addressListCode)

	//write addressListCode to sys contract
	state.SetCode(AddressListContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", AddressListContractAddr.String(), "code", addressListCode)

	return
}

func (s *hardForkAddressList) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return devAdmin
	}

	return devAdminTestnet
}

func GetAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return devAdmin
	}

	return devAdminTestnet
}

func (s *hardForkAddressList) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	method := "initialize"
	data, err := GetInteractiveABI()[AddressListContractName].Pack(method, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &AddressListContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
